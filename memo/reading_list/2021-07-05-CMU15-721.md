---
layout: memo
title: CMU15-721 Paper Reading Note
---

[Original list](https://15721.courses.cs.cmu.edu/spring2020/schedule.html)

# Topic 2: In-Memory Databases
## X. Yu, et al., Staring into the Abyss: An Evaluation of Concurrency Control with One Thousand Cores, in VLDB, 2014

# Topic 1: Course Introduction and History of Databases 
## A. Pavlo, et al., What's New with NewSQL?, in SIGMOD Record (vol. 45, iss. 2), 2016

### 背景
2000年代、インターネットアプリケーションの台頭で、同時接続数の大幅な増加や常時オンラインの要件が必要とされるようになり、
DBがボトルネックとなることが多くなりました。
DBのスケールアップでは費用対効果が悪く、スケールアウトにより処理能力を向上する方法が模索されました。
そうした中で現れたのがNoSQLのデータストアです。
トラディショナルなDBMSのモデルでは、性能と可用性を犠牲に一貫性と正確性が重視されましたが、
このトレードオフは多くのWebアプリケーションでは妥当ではないと考えられました。
また、キーによる単純な検索クエリにはSQLはオーバーキルであるという見方もありました。
NoSQLを使う利点は、スケーラビリティのことは気にせず、アプリケーションの開発に専念でき、
高い生産性を実現できることにあると考えられていました。

しかし結局のところ、多くのアプリケーションではトランザクションや一貫性の保証が重要であることがわかってきました。
アプリケーションで一貫性を保証するコストは高く、またトランザクションによる抽象化が人の理解を容易にするため、
生産性が高くなるという意見もあります。
そこで、2010年代になると、NoSQL並みのスケーラビリティを確保しつつ、ACIDを保証するNewSQLが現れました。
2000年代中盤から、VerticaやGreenplumといったOLAP向けDBMSで、スケールアウトに対応するものはありましたが、
これらはOLAP特化のため、この論文ではNewSQLには含めないと述べられています。
NewSQLは、トランザクショナルな読み書き必要とし、データ全体の一部をインデックス走査で読む短時間のクエリが、
異なるインプットに対して繰り返し実行されるといったワークロードをもつアプリケーションに特化しています。

### NewSQLの分類
この論文では、NewSQLを以下の3種類に分類にしています。
（ScaleDB, Hekaton, CitusDB, VitesseなどのシングルノードDBMSのストレージエンジン拡張はNewSQLに含めない）
- 新しいアーキテクチャでスクラッチ開発されたもの
  - Examples: Clustrix, CockroachDB, Google Spanner, H-Store, HyPer, MemSQL, NuoDB, SAP HANA, VoltDB
- 2000年代にGoogleなどによって開発されたミドルウェアによるシャーディングを再実装したもの
  - Examples: AgilData Scalable Cluster, MariaDB MaxScale, ScaleArc
- クラウドコンピューティングプロバイダによるDBaaS
  - Examples: Amazon Aurora, ClearDB
  - Auorora MySQLはmulti-masterをサポートするものの、コンフリクトのハンドリングなどで制限もあり、スケールアウトでどの程度性能向上するか不明

### Main memory storage
メモリの大容量化、低価格化を背景に、NewSQLでもメモリベースアーキテクチャのDBが見られるようになってきました。
メモリベースアーキテクチャのアイディア自体は、1980年代から見られましたが、NewSQLで目新しいのは、
メモリフットプリントを抑えるため、2次記憶へのデータの部分書き出しをサポートするといった工夫がみられる点です。

トラディショナルなDBMSでは、トランザクション処理等で大半の処理時間を専有しており、
意味のあるデータ処理を実行している時間は10%以下だった、などといった研究も見られており、
現代のハードウェアに合わせたアーキテクチャの見直しによって、DBMSの大幅な性能向上も期待されるところです。
[OLTP Through the Looking Glass, and What We Found There](https://dl.acm.org/doi/10.1145/1376616.1376713)

### Sharding / Partitioning
ともにホモジニアスなクラスタ構成をとる、NuoDBとMemSQLのシャーディング戦略について解説しています。
NuoDBでは、Transaction Engine（TE）が、Storage Manager（SM）によって分割されたデータブロック（atom）をキャッシュしており、
またデータが同じTEによって処理されやすくなるようなロードバランシングを行っています。
結果として、NuoDBでは事前のパーティショニングやテーブル間の関係なくして、他の分散DBMSと同様のパーティショニングを実現しています。

また、MemSQLでは、クエリ実行のみの集約ノードと、データを格納するリーフノードという構成をとり、リーフノードにクエリをプッシュダウン
することで、ノード間のデータ転送量を削減しています。

これらのNewSQLでは再パーティショニングなしで、ノード追加が可能です。（NuoDBのTE、MemSQLの集約ノード）

また、パーティションのライブマイグレーションといった、再パーティショニングの運用負荷を低減する仕組みもNoSQL / NewSQLではみられます。

### Concurrency control
ほとんどのNewSQLは、デッドロック検知の難しさから2PLを避ける傾向にあります。
最近では代わりに、Timestamp Ordering（TO）をベースにしたものが多いです。
NewSQLで広く用いられるプロトコルとして、ロングランニングなリードオンリークエリを、ライトをブロックせずに
実行できるという利点から、decentralized multi-version concurrency controlが用いられています。

Google Spannerのコンカレンシコントロール実装は一石を投じるもので、ベースは2PL + MVCCですが、ユニークな点として
GPSや原子時計といったハードウェアにより、高精度の時刻同期を実現しています。
Spannerの登場により、従来は分散DBMSに向かないと考えられていたTOが見直されました。
CockroachDBは、hybrid clock protocolによって原子時計無しで、Spannerと同等のコンカレンシコントロールを実現しています。
[Hybrid clock protocol of CockroachDB](https://www.cockroachlabs.com/blog/living-without-atomic-clocks/)

### Replication

### Crush recovery

### まとめと今後の展望
NewSQLとして登場したDBは、技術的にはほとんど過去に発見された技術の組み合わせであり、目新しいものは多くありません。
ハードウェアの進歩や、高並列度のOLTP、大規模データのOLAPを必要とするアプリケーションが増加したことにより、
エンジニアリング主導でプロダクトとなり実用化されてきた側面が強いです。

NewSQLの台頭により、今後は分散DBMSがコモディティ化していくのではないかと考えられます。
これからは、リアルタイムデータ分析やhybrid transaction-analytics processing（HTAP）といった、
過去データと新しいデータの組み合わせから知見を得るためのシステムへと進化していくと著者達は予測しています。